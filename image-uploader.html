<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymerfire/polymerfire.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="load-image.html">

<dom-module id="image-uploader">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }

      .image-placeholder {
        width: 100%;
        height: 100%;
        object-fit: contain;
        fill: #333;
      }

      .uploader {
        position: relative;
      }

      .uploaderImage iron-image {
        display: block;
        min-height: 232px;
        min-width: 232px;
        --iron-image-width: 100%;
        --iron-image-height: auto;
        --iron-image-placeholder: {
          background-color: var(--paper-grey-900);
        };
        @apply --image-styles;
      }

      #uploadImage {
        @apply --upload-icon-styles;
      }
    </style>
    <firebase-storage-ref
      id="firebase-storage-ref"
      path="/images/profiles"
      metadata="{{metadata}}"
      storage-uri="{{gsUri}}"
      download-url="{{downloadUrl}}">
    </firebase-storage-ref>
    <div class="uploader">
      <div class="uploaderImage">
        <template is="dom-if" if="[[!hasImage]]">
          <svg class="image-placeholder" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </template>
  <template is="dom-if" if="[[hasImage]]">
          <iron-image src="[[imageDataUrl]]" preload fade sizing="cover"></iron-image>
        </template>
  </div>
  <input id="fileInput" type="file" accept="image/*" capture="user" style="display:none;">
  <paper-fab id="uploadImage" icon="image:photo-camera" mini on-tap="_uploadImage"></paper-fab>
  </div>
  </template>

  <script>
    /**
     * `image-uploader`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ImageUploader extends Polymer.Element {
      /**
       * @return {string}
       */
      static get is() {
        return 'image-uploader';
      }
      /**
       * @return {Object}
       */
      static get properties() {
        return {
          imageDataUrl: {
            type: Object,
          },
          hasImage: {
            type: Boolean,
            value: false,
            computed: '_isDefined(imageDataUrl)',
            reflectToAttribute: true,
          },
          downloadUrl: {
            type: String,
          },
          gsUri: {
            type: String,
          },
          metadata: {
            type: Object,
            value: {
              contentType: 'image/jpeg',
            },
          },
        };
      }
      /**
       * Connected callback
       */
      connectedCallback() {
        super.connectedCallback();
      }
      /**
       * Ready function
       */
      ready() {
        super.ready();
        this.shadowRoot.querySelector('#fileInput')
          .addEventListener('change', (e) => this._upload(e.target));
      }
      /**
       * Upload file.
       * @param {object} target
       * @private
       */
      _upload(target) {
        const file = target.files ? target.files[0] : null;
        if (!file) {
          return;
        }
        this.shadowRoot.querySelector('#firebase-storage-ref')
          .put(file, this.metadata);
        window.loadImage(file, (canvas) => {
          if (this.imageDataUrl) {
            setTimeout(() => {
                this.imageDataUrl = canvas.toDataURL('image/jpeg');
              },
              450
            );
          } else {
            this.imageDataUrl = canvas.toDataURL('image/jpeg');
          }
        });
        // Reset to allow uploads of the same file again.
        target.value = '';
      }
      /**
       * Check if data is defined
       * @param {object} data
       * @return {boolean}
       * @private
       */
      _isDefined(data) {
        return !!data;
      }
      /**
       * Trigger click to upload image
       * @private
       */
      _uploadImage() {
        this.shadowRoot.querySelector('#fileInput').click();
      }
    }
    window.customElements.define(ImageUploader.is, ImageUploader);

  </script>
</dom-module>
